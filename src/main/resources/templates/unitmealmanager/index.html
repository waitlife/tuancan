<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>jQuery WeUI</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
    ">
    <link href="/assets/css/bootstrap.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/demos.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/1.1.3/style/weui.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-weui/1.2.1/css/jquery-weui.min.css">
    <!-- order Styles-->
    <!--<link href="/css/order.css" type="text/css" rel="stylesheet">-->
<!--
    <link href="/webjars/amazeui/2.7.2/dist/css/amazeui.css" type="text/css" rel="stylesheet">
-->

</head>

<body ontouchstart>
<div class="weui-cell" id="headavr" style="top: 0px;z-index: 100;">
    <a href="javacript:;">
        <div class="weui-cell__hd"><img src="/icon/avatar.jpg" alt="" style="width:20px;margin-right:5px;display:block">
        </div>
    </a>
    <div class="weui-cell__bd">
        <p>账户</p>
    </div>
    <div class="weui-cell__ft">
        <a href="javascript:;" class="weui-form-preview__btn weui-form-preview__btn_primary open-popup"
           data-target="#half">操作</a>
    </div>
</div>
<div class="weui-tab" id="tabbody">
    <div class="weui-tab__bd">

        <div th:replace="unitmealmanager/delivermaster :: tab1"></div>

        <div th:replace="unitmealmanager/unitstaff_list :: tab2"></div>

        <div th:replace="unitmealmanager/order :: tab3"></div>

        <div th:replace="unitmealmanager/personal :: tab4"></div>


    </div>

    <div class="weui-tabbar" style="position: fixed;bottom: 0em;">
        <a href="#tab1" class="weui-tabbar__item weui-bar__item--on">
            <span class="weui-badge" style="position: absolute;top: -.4em;right: 1em;">8</span>
            <div class="weui-tabbar__icon">
                <img src="/icon/icon_nav_button.png" alt="">
            </div>
            <p class="weui-tabbar__label">首页</p>
        </a>
        <a href="#tab2" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="/icon/icon_nav_msg.png" alt="">
            </div>
            <p class="weui-tabbar__label">员工</p>
        </a>
        <a href="#tab3" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="/icon/icon_nav_article.png" alt="">
            </div>
            <p class="weui-tabbar__label">点餐</p>
        </a>
        <a href="#tab4" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <img src="/icon/icon_nav_cell.png" alt="">
            </div>
            <p class="weui-tabbar__label">其他</p>
        </a>
    </div>
</div>

<!--//pop-->
<div id="half" class='weui-popup__container popup-bottom' style="z-index: 999;">
    <div class="weui-popup__overlay"></div>
    <div class="weui-popup__modal">
        <div class="toolbar">
            <div class="toolbar-inner">
                <a href="javascript:;" class="picker-button close-popup">关闭</a>
                <!--<h1 class="title">操作</h1>-->
            </div>
        </div>
        <div class="modal-content">
            <div class="weui-grids">
                <!--<button id="addtype" data-toggle="modal" data-target="#myModal" class="btn btn-primary" type="button">添加</button>-->
                <a href="javascript:;" class="emergy weui-grid js_grid" data-id="dialog" data-toggle="modal"
                   data-target="#myModal">
                    <div class="weui-grid__icon">
                        <img src="/icon/icon_nav_progress.png" alt="">
                    </div>
                    <p class="weui-grid__label">
                        应急
                    </p>
                </a>
                <a href="javascript:;" class="weui-grid js_grid" data-id="progress">
                    <div class="weui-grid__icon">
                        <img src="/icon/icon_nav_dialog.png" alt="">
                    </div>
                    <p class="weui-grid__label">
                        消息
                    </p>
                </a>
                <a href="javascript:;" class="emergy weui-grid js_grid" data-id="msg" data-toggle="modal"
                   data-target="#myModal1">
                    <div class="weui-grid__icon">
                        <img src="/icon/icon_nav_msg.png" alt="">
                    </div>
                    <p class="weui-grid__label">
                        添加员工
                    </p>
                </a>
            </div>
        </div>
    </div>
</div>

<!--
<script src="/webjars/jquery/3.3.0/jquery.js"></script>
-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    填写应急配送单
                </h4>
            </div>
            <div class="modal-body">
                <div class="weui-cells weui-cells_form ">
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">单价:</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="inputprice" type="text" placeholder="请输入单价">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">数量:</label></div>
                        <div class="weui-cell__bd">
                            <div class="weui-count">
                                <a class="weui-count__btn weui-count__decrease"></a>
                                <input class="weui-count__number " id="inputnum" type="number" th:value="1"/>
                                <a class="weui-count__btn weui-count__increase"></a>
                            </div>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label for="" class="weui-label">配送日期</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="inputdate" type="text" value="">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">备注:</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="inputmemo" type="text" placeholder="填写备注">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button id="confirm_commit" type="button" class="btn btn-primary">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel1">
                    填写员工信息
                </h4>
            </div>
            <div class="modal-body">
                <div class="weui-cells weui-cells_form ">
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">姓名:</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="staffname" type="text" placeholder="请输入单价">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">性别:</label></div>
                        <div class="weui-cell__bd">
                            <div class="btn-toolbar" role="toolbar">
                                <div class="btn-group">
                                    <button type="button" class="btn btnselect" th:text="男" lang="1" data-th-classappend="${'btn-success'}">男</button>
                                    <button type="button" class="btn btnselect" th:text="女" lang="0" data-th-classappend="${'btn-default'}">女</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label for="" class="weui-label">手机号码</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="staffmobile" type="text" value="">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">备注:</label></div>
                        <div class="weui-cell__bd">
                            <input class="weui-input" id="" type="text" placeholder="填写备注">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
                <button id="confirm_commit1" type="button" class="btn btn-primary">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<!-- body 最后 -->
<script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
<!--
<script src="../lib/jquery-2.1.4.js"></script>
-->
<script src="/js/fastclick.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/jquery-weui.min.js"></script>
<!-- 如果使用了某些拓展插件还需要额外的JS -->
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/swiper.min.js"></script>
<script src="https://cdn.bootcss.com/jquery-weui/1.2.1/js/city-picker.min.js"></script>
<script type="text/javascript">
    $(function () {
        var pageNum = 1;
        var htm = "<div class=\"weui-loadmore loadmorerr weui-loadmore_line weui-loadmore_dot\">\n" +
            "  <span class=\"weui-loadmore__tips\"></span>\n" +
            "</div>";
        FastClick.attach(document.body);
        $("#headavr").show();
        //页面加载完成，载入配送单
        $.ajax({
            url: "/deliveringMaster/unitlist/",
            type: "POST",
            data: {},
            error: function (error) {
                $.toast("网络错误", "cancel");
            },
            success: function (result) {
                //alert("ok");
                $("#deliverpreview").append(result + "<div class=\"weui-loadmore weui-loadmore_line\">\n" +
                    "               <span class=\"weui-loadmore__tips\">以下为历史消息</span>\n" +
                    "              </div>");
            },
        });
        //tabar状态转换
        $(".weui-tabbar__item").click(function () {
            var $this = $(this);
            //var id = $this.attr("id");
            var href = $this.attr("href");

            if ($this.hasClass("weui-bar__item--on")) {
                return;
            }
            $(href).siblings("div").removeClass("weui-tab__bd-item--active").addClass("weui-tab__bd-item--active");

            if (href == '#tab2') {
                //alert(href);
                $("#headavr").show();
                $.showLoading();
                setTimeout(function() {
                    $.ajax({
                        url: "/groupmealstaff/manager",
                        type: "POST",
                        data: {},
                        error: function (error) {
                            $.toast("网络错误", "cancel");
                        },
                        success: function (result) {
                            $("#searchtable").html(result);
                            $.hideLoading();
                            $('.weui-cell_swiped').swipeout()
                        },
                    });
                }, 1000);
            } else if (href == '#tab3') {
                //alert(href);
                $("#headavr").show();
                //$("#cart_msg").hide();
                orderlist();

            } else if (href == "#tab4") {
              //  alert(href);
                $("#headavr").hide();
            } else {
                $("#headavr").show();
                return;
            }
        });
        function orderlist(){
            $.showLoading();
            setTimeout(function() {
                $.ajax({
                    url: "/tomorrowmenu/show",
                    type: "GET",
                    data: {},
                    error: function (error) {
                        $.toast("网络错误", "cancel");
                    },
                    success: function (result) {
                        $("#ordercontent").remove();
                        $("#outer").append(result);
                        $.hideLoading();
                        $('.weui-cell_swiped').swipeout();
                    },
                });
            }, 1000);
        }
        //确认提交
        $(document).on("click", ".confirm", function () {
            $this = $(this);
            var idstr = $($this).attr("id");
            var time = $($this).parent("div").prev("div").find("span.time").text();
            var num = $($this).parent("div").prev("div").find("input.weui-count__number").val();
            console.log(num);
            $.confirm({
                title: '确认提交？',
                text: '用餐人数:' + num + '，配送时间:' + time + '，确认无误后提交',
                onOK: function () {
                    $.showLoading("正在提交");
                    //点击确认
                    $.ajax({
                        url: "/deliveringMaster/updatenum/",
                        type: "POST",
                        data: {
                            "id": idstr,
                            "num": num
                        },
                        error: function (error) {
                            $.toast("网络错误", "cancel");
                        },
                        success: function (result) {
                            $($this).text("已确认");
                            $($this).removeClass("weui-form-preview__btn_primary confirm").addClass("weui-form-preview__btn_disable");
                            $.hideLoading();
                            $.toast("确认成功!");
                        },
                    });
                },
                onCancel: function () {
                    $.toast("取消操作", "cancel");
                }

            });
        });

        //加载刷新时间
        var loading = false;  //状态标记

        //$(document.body).infinite(200);
        $("#tab1").infinite().on("infinite", function () {
            if (loading) return;
            loading = true;
            //$("body").append(loadhtm);
            setTimeout(function () {
                //$('.loadmo').show();
                pageNum++;
                $.ajax({
                    url: "/deliveringMaster/unitlist/" + pageNum,
                    type: "POST",
                    data: {},
                    error: function (error) {
                        $.toast("网络错误", "cancel");
                    },
                    success: function (result) {
                        if (result == "" || result == null) {
                            $("#tab1").destroyInfinite();
                            $(".loadmo").remove();
                            $("#deliverpreview").append("<div class=\"weui-loadmore  weui-loadmore_line\">\n" +
                                "  <span class=\"weui-loadmore__tips\">暂无数据</span>\n" +
                                "</div><br><br>");
                            $(".loadmorerr").last().remove();
                            return;
                        }
                        $("#deliverpreview").append(result + htm);
                        // $('.loadmo').hide();
                    },
                });
                loading = false;
            }, 1000);

            //如果你不需要滚动加载了，比如已经加载完了所有内容，
            // 调用 $(document.body).destroyInfinite() 可以销毁插件。
        });

        //数量增加
        var MAX = 99, MIN = 1;
        $(document).on("click", ".weui-count__decrease", function (e) {
            //$('.weui-count__decrease').click(function (e) {
            var $input = $(e.currentTarget).parent().find('.weui-count__number');
            var number = parseInt($input.val() || "0") - 1;
            if (number < MIN) number = MIN;
            //alert(number);
            $input.val(number);
        });
        $(document).on("click", ".weui-count__increase", function (e) {
            // $('.weui-count__increase').click(function (e) {
            var $input = $(e.currentTarget).parent().find('.weui-count__number');
            var number = parseInt($input.val() || "0") + 1;
            if (number > MAX) number = MAX;
            $input.val(number);
        });

        //发布
        var price;
        var datetimer;
        var num = 1;
        var memo = "";
        var check = true;
        $(document).on("change", "#inputprice", function (e) {
            price = $(e.currentTarget).val();
            check = true;
            //alert(price);
            var reg = /^(\d+)([.]?)(\d{0,2})$/;
            if (!reg.test(price)) {
                check = false;
                console.log(">>" + check);
                $.toast("输入错误", "cancel");
            }
            console.log(reg.test("15.6"));
            console.log(reg.test("156"));
            console.log(reg.test("15.67"));
            console.log(reg.test("15.678"));
            console.log(reg.test("5.68"));
            console.log(reg.test(".68"));
        });
        $(document).on("click", "#inputdate", function (e) {
            $(".weui-picker-container").css("z-index", "9000");
        });
        $(document).on("change", "#inputmemo", function (e) {
            memo = $(e.currentTarget).val();
            check = true;

            if (datetimer.length <= 0) {
                check = false;
                console.log(">>" + check);

            }
            if ($.isEmptyObject(memo) || memo.length <= 0) {
                check = false;
            }
            console.log(">>" + check);
        });
        $(document).on("change", "#inputnum", function (e) {
            num = $(e.currentTarget).val();
        });

        //时间
        $("#inputdate").datetimePicker({
            times: function () {
                return [
                    {
                        values: (function () {
                            var hours = [];
                            for (var i = 0; i < 24; i++) hours.push(i > 9 ? i : '0' + i);
                            return hours;
                        })()
                    },
                    {
                        divider: true,  // 这是一个分隔符
                        content: '时'
                    }
                ];
            },
            onChange: function (picker, values, displayValues) {
                temptime = values.slice(0, 3).join("-") + ' ' + values[3].toString() + ':00:00';
                //console.log(values);
                console.log(temptime);
                datetimer = Date.parse(temptime);
                console.log(datetimer);
            },
        });
        //填写配送单
        $(document).on("click", "#confirm_commit", function (e) {
            if (!check) {
                $.toast("信息输入错误！", "cancel");
                return;
            }
            $.ajax({
                url: "/deliveringMaster/emergency/?price=" + price + "&date=" + datetimer + "&num=" + num + "&memo=" + memo,
                type: "POST",
                data: {},
                contentType: "application/json",
                error: function (error) {
                    $.toast("网络错误", "cancel");
                },
                success: function (result) {
                    $('#myModal').modal('hide');
                    $.toast("提交成功！");
                    // $.closeModal();
                },
            });
        });
        $(".emergy").click(function () {
            $.closePopup();
        });
        $('#myModal').on('hidden.bs.modal', function () {
            // 执行一些动作...
            $('#inputdate').val('');
            $('#inputprice').val('');
            $('#inputnum').val('');
            $('#inputmemo').val('');
        });


        //搜索
        var searchanme;
        var searchnum=1;
        function searchname() {
            setTimeout(function () {
                $.ajax({
                    url: "/groupmealstaff/search/"+searchanme+"/"+searchnum++,
                    type: "POST",
                    data: {
                        "asyc":true,
                    },
                    error: function (error) {
                        $.toast("网络错误", "cancel");
                    },
                    success: function (result) {
                        if (result == "" || result == null) {
                            $.hideLoading();
                            $.toast("没有更多数据了","cancel");
                            return;
                        }
                        $("#searchtable").html(result);
                        $.hideLoading();
                        $('.weui-cell_swiped').swipeout();
                    },
                });
            },1000);
        }
        $("#searchInput").keydown(function (e) {

            if (e.keyCode == 13) {
                e.preventDefault();
               // alert($(e.currentTarget).val());
                searchanme=$(e.currentTarget).val();
                $.showLoading();
                searchname();
            }
        });

        //员工滑动修改状态
        $(document).on('click', '.close-swipeout', function () {
            $(this).parents('.weui-cell').swipeout('close');
        });
        $(document).on('click', '.statuswipe', function (e) {
            addurl=$(e.currentTarget).attr("lang");
            $.ajax({
                url: "/groupmealstaff"+addurl,
                type: "POST",
                data: {},
                contentType: "application/json",
                error: function (error) {
                    $.toast("网络错误", "cancel");
                },
                success: function (result) {
                    //$(e.currentTarget).text("启用");
                    //($(e.currentTarget).text()=="启用" ?"禁用":"xx");
                    $(e.currentTarget).parents('.weui-cell').swipeout('close');
                    $.toast("更改成功！");
                }
            });
        });
        //查看更多
        $(document).on('click', '#seemore', function (e) {
            $.showLoading();
            namepath=$("#manager").attr("lang");
            console.log(namepath);
            e.preventDefault();
            setTimeout(function () {
                $.ajax({
                    url: namepath,
                    type: "POST",
                    data: {
                        "asyc":true,
                    },
                    error: function (error) {
                        $.toast("网络错误", "cancel");
                    },
                    success: function (result) {
                        if (result == "" || result == null) {
                            $.hideLoading();
                            $.toast("没有更多数据了","cancel");
                            return;
                        }
                        $("#searchtable").append(result);
                        $.hideLoading();
                        $('.weui-cell_swiped').swipeout();
                    },
                });
            },1000);

        });

        //员工信息填写
        var staffname="";
        var staffmobile;
        var staffsex=1;
        var staffcheck=true;
        $(document).on("change", "#staffname", function (e) {
            var staffcheck=true;
            staffname = $(e.currentTarget).val();
           if (staffname.length<=0 || $.isEmptyObject(staffname)){
               staffcheck=false;
           }
        });
        $(document).on("click", ".btnselect", function (e) {
            var check=$(e.currentTarget).hasClass("btn-success");
            if (check){
                $(e.currentTarget).siblings('button').removeClass("btn-success").addClass("btn-default");
            }else {
                $(e.currentTarget).addClass("btn-success").removeClass("btn-default");
                $(e.currentTarget).siblings('button').removeClass("btn-success").addClass("btn-default");
            }

            staffsex=$(this).attr("lang");
            console.log(staffsex);
        });
        $(document).on("change", "#staffmobile", function (e) {
            staffmobile = $(e.currentTarget).val();
            staffcheck = true;
            regmobile=/^\d{11}$/;
            staffcheck=regmobile.test(staffmobile);
            if (!staffcheck){
                $.toast("手机号码填写错误","cancel");
            }
        });
        $('#myModal1').on('hidden.bs.modal', function () {
            // 执行一些动作...
            $('#staffname').val('');
            $('#staffmobile').val('');
        });
        $(document).on("click", "#confirm_commit1", function (e) {
            if (!staffcheck) {
                $.toast("信息输入错误！", "cancel");
                return;
            }
            $.ajax({
                url: "/groupmealstaff/addstaff?gMStaffName="+staffname+"&gMStaffSex="+staffsex+"&gMStafMobile="+staffmobile,
                type: "POST",
                data: {
                    "gMStaffName":staffname,
                    "gMStaffSex" :staffsex,
                    "gMStafMobile" : staffmobile
                },
                contentType: "application/json",
                error: function (error) {
                    $.toast("网络错误", "cancel");
                },
                success: function (result) {
                    $('#myModal1').modal('hide');
                    $.toast("提交成功！");
                    // $.closeModal();
                },
            });
        });

    });
</script>
<script src="/js/order.js" type="text/javascript"></script>

</body>
</html>